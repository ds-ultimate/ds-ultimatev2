(()=>{"use strict";function r(r){return function(r){if(Array.isArray(r))return a(r)}(r)||function(r){if("undefined"!=typeof Symbol&&null!=r[Symbol.iterator]||null!=r["@@iterator"])return Array.from(r)}(r)||function(r,t){if(r){if("string"==typeof r)return a(r,t);var e={}.toString.call(r).slice(8,-1);return"Object"===e&&r.constructor&&(e=r.constructor.name),"Map"===e||"Set"===e?Array.from(r):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?a(r,t):void 0}}(r)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(r,a){(null==a||a>r.length)&&(a=r.length);for(var t=0,e=Array(a);t<a;t++)e[t]=r[t];return e}function t(r){throw new TypeError('"'+r+'" is read-only')}var e=[20,97,194,272,340,402,459,512,562,610,656,699,742,783,822,861,898,935,971,1006,1040];function n(r){var a=r.attacker.ram;r.attackerBelieve||t("ramCount");var e=r.wall-Math.round(a/(4*Math.pow(1.09,r.wall)));return e<Math.round(r.wall/2)?Math.round(r.wall/2):e}function c(r){var a={infantry:[],cavalry:[],archer:[],spy:[]};return r.forEach(function(r,t){switch(r){case"spear":case"sword":case"axe":case"ram":case"snob":case"catapult":a.infantry.push(t);break;case"light":case"heavy":case"knight":a.cavalry.push(t);break;case"archer":case"marcher":a.archer.push(t);break;case"spy":a.spy.push(t)}}),a}function u(r,a,t,e){var n=r.morale/100*((r.luck+100)/100)*(r.attackerBelieve?1:.5);return{infantry:n*a.infantry.map(function(r){return e[r]*t[r].attack}).reduce(function(r,a){return r+a},0),cavalry:n*a.cavalry.map(function(r){return e[r]*t[r].attack}).reduce(function(r,a){return r+a},0),archer:n*a.archer.map(function(r){return e[r]*t[r].attack}).reduce(function(r,a){return r+a},0)}}function o(r,a,t,n,c,u){var o=t.infantry+t.cavalry+t.archer;0==o&&(o=1);var i=t.infantry/o,f=t.cavalry/o,v=t.archer/o,d=r.defenderBelieve?1:.5,s=r.nightBonus;if(0!==r.farmLimit)throw new Error("Farmlimit is not supported");var l=1*d*s*Math.pow(1.037,n),k=u?e[n]:0;return{infantry:i*(k+l*c.map(function(r,t){return r*a[t].defense}).reduce(function(r,a){return r+a},0)),cavalry:f*(k+l*c.map(function(r,t){return r*a[t].defense_cavalry}).reduce(function(r,a){return r+a},0)),archer:v*(k+l*c.map(function(r,t){return r*a[t].defense_archer}).reduce(function(r,a){return r+a},0))}}function i(r,a){return a.reduce(function(a,t,e){return a[t]=r[e],a},{})}function f(a,e,n,c){var u=a.attacker.ram;if(a.attackerBelieve||t("ramCount"),u<=0)return a.wall;var o=u*e.ram.attack/(4*Math.pow(1.09,a.wall));if(n.attackerSurvivor.some(function(r){return r>0})){var i=0,f=0;[].concat(r(c.infantry),r(c.cavalry),r(c.archer)).forEach(function(r){f+=n.attacker[r],i+=n.attackerLoss[r]});var v=i/f,d=Math.round(o*(1-v/2)),s=a.wall-d;return s<0?0:s}var l=n.defenderLoss.reduce(function(r,a){return r+a},0)/n.defender.reduce(function(r,a){return r+a},0),k=Math.round(l*o/2),h=a.wall-k;return h<0?0:h}function v(r,a){return r.catapultTargetsWall?a:r.catapultBuilding}function d(a,e,n,c,u){var o=a.attacker.catapult;if(o<=0)return u;a.attackerBelieve||t("cataCount");var i=function(r,a,t,e){if(!(r.cataChurch&&t<=3))return a*e.catapult.attack/(300*Math.pow(1.09,t));switch(t){case 1:return a/800;case 2:return a/333;case 3:return a/240;default:return-1}}(a,o,u,e),f=0;if(n.attackerSurvivor.some(function(r){return r>0})){var v=0,d=0;[].concat(r(c.infantry),r(c.cavalry),r(c.archer)).forEach(function(r){d+=n.attacker[r],v+=n.attackerLoss[r]});var s=v/d;f=Math.round(i*(1-s/2))}else{var l=n.defenderLoss.reduce(function(r,a){return r+a},0)/n.defender.reduce(function(r,a){return r+a},0);f=Math.round(l*i/2)}var k=u-f;return k<0?0:k}function s(r,a,t){var e=1.5;0!==r.farmLimit&&(e=1.6);var n={};return["infantry","cavalry","archer"].forEach(function(r){0==a[r]||0==t[r]?n[r]=0:a[r]>t[r]?n[r]=Math.pow(t[r]/a[r],e):n[r]=1}),n}function l(r,a,t,e,n,c,u){if(u.infantry.forEach(function(r){var t=a.attackerSurvivor[r],n=Math.round(t*(1-e.infantry));a.attackerSurvivor[r]=n,a.attackerLoss[r]=a.attacker[r]-n}),u.cavalry.forEach(function(r){var t=a.attackerSurvivor[r],n=Math.round(t*(1-e.cavalry));a.attackerSurvivor[r]=n,a.attackerLoss[r]=a.attacker[r]-n}),u.archer.forEach(function(r){var t=a.attackerSurvivor[r],n=Math.round(t*(1-e.archer));a.attackerSurvivor[r]=n,a.attackerLoss[r]=a.attacker[r]-n}),c){var o=1.5;0!==r.farmLimit&&(o=1.6),u.spy.forEach(function(r){var t=a.attackerSurvivor[r],e=a.defenderSurvivor[r],n=0;n=0==t?0:(e+1)/t>=2?t:Math.round(t*Math.pow((e+1)/(2*t),o)),a.attackerSurvivor[r]=a.attacker[r]-n,a.attackerLoss[r]=n})}for(var i=t.infantry+t.cavalry+t.archer,f=a.defender.length,v=(t.infantry*n.infantry+t.cavalry*n.cavalry+t.archer*n.archer)/(0==i?1:i),d=0;d<f;d++){var s=a.defenderSurvivor[d],l=Math.round(s*(1-v));a.defenderSurvivor[d]=l,a.defenderLoss[d]=a.defender[d]-l}return a}function k(r){var a=n(r),t=Object.keys(r.attacker),e=t.map(function(r){return serverUnits[r]}),s=c(t),l={attacker:t.map(function(a){return r.attacker[a]}),attackerLoss:t.map(function(r){return 0}),attackerSurvivor:t.map(function(a){return r.attacker[a]}),defender:t.map(function(a){return r.defender[a]}),defenderLoss:t.map(function(r){return 0}),defenderSurvivor:t.map(function(a){return r.defender[a]})},k=u(r,s,e,l.attackerSurvivor),y=o(r,e,k,a,l.defenderSurvivor,!0),p=k.infantry+k.cavalry,m=y.infantry+y.cavalry,S=h(r,p,m),w=h(r,m,p);l=function(r,a,t,e,n){n.infantry.forEach(function(r){var e=a.attackerSurvivor[r],n=Math.round(e*t);a.attackerSurvivor[r]=a.attacker[r]-n,a.attackerLoss[r]=n}),n.cavalry.forEach(function(r){var e=a.attackerSurvivor[r],n=Math.round(e*t);a.attackerSurvivor[r]=a.attacker[r]-n,a.attackerLoss[r]=n});var c=2,u=1.5;0!==r.farmLimit&&(u=1.6);n.spy.forEach(function(r){var t=a.attackerSurvivor[r],e=a.defenderSurvivor[r],n=0;n=0==t?0:(e+1)/t>=c?t:Math.round(t*Math.pow((e+1)/(t*c),u)),a.attackerSurvivor[r]=a.attacker[r]-n,a.attackerLoss[r]=n});for(var o=a.defender.length,i=0;i<o;i++){var f=a.defenderSurvivor[i],v=Math.round(f*e);a.defenderSurvivor[i]=a.defender[i]-v,a.defenderLoss[i]=v}return a}(r,l,S,w,s);var L=f(r,serverUnits,l,s),M=v(r,L),b=d(r,serverUnits,l,s,M);return{attacker:i(l.attacker,t),attackerLoss:i(l.attackerLoss,t),attackerSurvivor:i(l.attackerSurvivor,t),defender:i(l.defender,t),defenderLoss:i(l.defenderLoss,t),defenderSurvivor:i(l.defenderSurvivor,t),wallOld:r.wall,wallNew:L,catapultOld:M,catapultNew:b}}function h(r,a,t){var e=1.5;return 0!==r.farmLimit&&(e=1.6),0==a||0==t?0:a>t?Math.pow(t/a,e):1}window.runSimulation=function(r,a){return r.newSimulator?function(r,a){for(var t=n(r),e=Object.keys(r.attacker),k=e.map(function(r){return a[r]}),h=c(e),y={attacker:e.map(function(a){return r.attacker[a]}),attackerLoss:e.map(function(r){return 0}),attackerSurvivor:e.map(function(a){return r.attacker[a]}),defender:e.map(function(a){return r.defender[a]}),defenderLoss:e.map(function(r){return 0}),defenderSurvivor:e.map(function(a){return r.defender[a]})},p=0;p<3;p++){var m=u(r,h,k,y.attackerSurvivor),S=o(r,k,m,t,y.defenderSurvivor,0==p),w=s(r,m,S),L=s(r,S,m);y=l(r,y,m,w,L,0==p,h)}var M=f(r,a,y,h),b=v(r,M),E=d(r,a,y,h,b);return{attacker:i(y.attacker,e),attackerLoss:i(y.attackerLoss,e),attackerSurvivor:i(y.attackerSurvivor,e),defender:i(y.defender,e),defenderLoss:i(y.defenderLoss,e),defenderSurvivor:i(y.defenderSurvivor,e),wallOld:r.wall,wallNew:M,catapultOld:b,catapultNew:E}}(r,a):k(r)}})();